# Spring PetClinic CI/CD ìë™ ë°°í¬ ë° ì„œë¹„ìŠ¤ ë™ì‘ íë¦„ ì„¤ëª…

## ğŸ“‹ ëª©ì°¨
1. [ì•„í‚¤í…ì²˜ ê°œìš”](#ì•„í‚¤í…ì²˜-ê°œìš”)
2. [ì „ì²´ ë°°í¬ íë¦„](#ì „ì²´-ë°°í¬-íë¦„)
3. [ê° ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…](#ê°-ë‹¨ê³„ë³„-ìƒì„¸-ì„¤ëª…)
4. [ë„¤íŠ¸ì›Œí¬ ë° ë³´ì•ˆ êµ¬ì„±](#ë„¤íŠ¸ì›Œí¬-ë°-ë³´ì•ˆ-êµ¬ì„±)
5. [ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…](#ëª¨ë‹ˆí„°ë§-ë°-ë¡œê¹…)

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

### ì‹œìŠ¤í…œ êµ¬ì„±ë„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Developer â”‚ â”€â”€â”€> â”‚  GitHub Repo â”‚ â”€â”€â”€> â”‚   Jenkins   â”‚ â”€â”€â”€> â”‚     ECR      â”‚ â”€â”€â”€> â”‚     ECS     â”‚
â”‚   (Git Push)â”‚      â”‚              â”‚      â”‚   (CI/CD)   â”‚      â”‚   (Images)   â”‚      â”‚  (Fargate)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                                              â”‚
                                                                                              â–¼
                                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                                        â”‚     ALB     â”‚
                                                                                        â”‚ (Load Bal.) â”‚
                                                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                                              â”‚
                                                                                              â–¼
                                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                                        â”‚   Users     â”‚
                                                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                                              â”‚
                                                                                              â–¼
                                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                                        â”‚     RDS     â”‚
                                                                                        â”‚ (PostgreSQL)â”‚
                                                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ìš” ì»´í¬ë„ŒíŠ¸
- **GitHub**: ì†ŒìŠ¤ ì½”ë“œ ì €ì¥ì†Œ
- **Jenkins**: CI/CD ìë™í™” ì—”ì§„
- **ECR (Elastic Container Registry)**: Docker ì´ë¯¸ì§€ ì €ì¥ì†Œ
- **ECS Fargate**: ì„œë²„ë¦¬ìŠ¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™˜ê²½
- **ALB (Application Load Balancer)**: L7 ë¡œë“œë°¸ëŸ°ì„œ
- **RDS PostgreSQL**: ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ (Master/Slave êµ¬ì„±)

---

## ğŸš€ ì „ì²´ ë°°í¬ íë¦„

### End-to-End ìë™í™” í”„ë¡œì„¸ìŠ¤

```
1ï¸âƒ£ Git Push
   â”‚
   â”œâ”€> GitHub Repositoryì— ì½”ë“œ ë³€ê²½ í‘¸ì‹œ
   â””â”€> Jenkins Webhook íŠ¸ë¦¬ê±°

2ï¸âƒ£ Jenkins ë¹Œë“œ
   â”‚
   â”œâ”€> â‘  Checkout: GitHubì—ì„œ ìµœì‹  ì½”ë“œ í´ë¡ 
   â”œâ”€> â‘¡ Build: Gradleë¡œ Spring Boot JAR ë¹Œë“œ
   â”œâ”€> â‘¢ Docker Build: Dockerfileë¡œ ì´ë¯¸ì§€ ìƒì„±
   â”œâ”€> â‘£ ECR Login: AWS ECR ì¸ì¦
   â””â”€> â‘¤ Push: 3ê°œ ì´ë¯¸ì§€ ECRì— ì—…ë¡œë“œ

3ï¸âƒ£ ECR ì´ë¯¸ì§€ ì €ì¥
   â”‚
   â”œâ”€> front:latest, front:<BUILD_NUMBER>
   â”œâ”€> back1:latest, back1:<BUILD_NUMBER>
   â””â”€> back2:latest, back2:<BUILD_NUMBER>

4ï¸âƒ£ ECS ì„œë¹„ìŠ¤ ì¬ë°°í¬
   â”‚
   â”œâ”€> front-service: ìƒˆ Task ì‹¤í–‰
   â”œâ”€> back1-service: ìƒˆ Task ì‹¤í–‰
   â””â”€> back2-service: ìƒˆ Task ì‹¤í–‰

5ï¸âƒ£ ALBë¥¼ í†µí•œ ì„œë¹„ìŠ¤ ì‘ë‹µ
   â”‚
   â”œâ”€> Target Group Health Check
   â”œâ”€> íŠ¸ë˜í”½ ë¼ìš°íŒ… (ê°€ì¤‘ì¹˜ ê¸°ë°˜)
   â””â”€> ì‚¬ìš©ì ìš”ì²­ ì²˜ë¦¬
```

---

## ğŸ“ ê° ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…

### 1ë‹¨ê³„: Git Push â†’ Jenkins íŠ¸ë¦¬ê±°

#### ë™ì‘ ê³¼ì •
1. ê°œë°œìê°€ ë¡œì»¬ì—ì„œ ì½”ë“œ ìˆ˜ì • í›„ Git Push ìˆ˜í–‰
   ```bash
   git add .
   git commit -m "feat: ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€"
   git push origin main
   ```

2. GitHubì´ Jenkinsì— Webhook ì „ì†¡
   - Webhook URL: `http://<jenkins-server>:8080/github-webhook/`
   - Payload: ì»¤ë°‹ ì •ë³´, ë¸Œëœì¹˜ ì •ë³´ í¬í•¨

3. Jenkinsê°€ ìë™ìœ¼ë¡œ ë¹Œë“œ Job ì‹œì‘
   - GitHub Pluginì´ Webhook ìˆ˜ì‹ 
   - Pipeline ì‹¤í–‰ ì‹œì‘

#### ì„¤ì • ìš”êµ¬ì‚¬í•­
- Jenkins GitHub Plugin ì„¤ì¹˜
- GitHub Repositoryì— Webhook ì„¤ì •
- Jenkins Credentialsì— GitHub Token ë“±ë¡

---

### 2ë‹¨ê³„: Jenkins ë¹Œë“œ í”„ë¡œì„¸ìŠ¤

#### Stage 1: Checkout
```groovy
stage('Checkout') {
    steps {
        git branch: 'main',
            url: 'https://github.com/<username>/spring-petclinic.git'
    }
}
```
- GitHubì—ì„œ ìµœì‹  ì†ŒìŠ¤ ì½”ë“œë¥¼ í´ë¡ 
- `main` ë¸Œëœì¹˜ì˜ ìµœì‹  ì»¤ë°‹ì„ ê°€ì ¸ì˜´

#### Stage 2: Build Application
```groovy
stage('Build Application') {
    steps {
        sh '''
            chmod +x gradlew
            ./gradlew clean bootJar -x test --no-daemon
        '''
    }
}
```
- **Gradle Wrapper**ë¥¼ ì‚¬ìš©í•´ Spring Boot JAR ë¹Œë“œ
- `clean`: ì´ì „ ë¹Œë“œ ì‚°ì¶œë¬¼ ì‚­ì œ
- `bootJar`: ì‹¤í–‰ ê°€ëŠ¥í•œ FAT JAR ìƒì„±
- `-x test`: í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ (ë¹Œë“œ ì†ë„ í–¥ìƒ)
- `--no-daemon`: CI í™˜ê²½ì—ì„œ ë°ëª¬ í”„ë¡œì„¸ìŠ¤ ë¹„í™œì„±í™”

**ë¹Œë“œ ê²°ê³¼**:
- `build/libs/spring-petclinic-4.0.0-SNAPSHOT.jar` ìƒì„±

#### Stage 3: Build Docker Images
```groovy
stage('Build Docker Images') {
    steps {
        sh """
            docker build -t ${ECR_REGISTRY}/front:${IMAGE_TAG} .
            docker tag ${ECR_REGISTRY}/front:${IMAGE_TAG} ${ECR_REGISTRY}/front:latest
            # back1, back2ë„ ë™ì¼í•œ ì´ë¯¸ì§€ë¡œ íƒœê·¸
        """
    }
}
```

**Dockerfile êµ¬ì¡°** (Multi-stage Build):
```dockerfile
# Stage 1: Build (Gradle + JDK 17)
FROM gradle:8.11.1-jdk17 AS builder
WORKDIR /app
COPY build.gradle settings.gradle ./
COPY src ./src
RUN gradle bootJar --no-daemon -x test

# Stage 2: Runtime (JRE 17)
FROM eclipse-temurin:17-jre-jammy
WORKDIR /app
COPY --from=builder /app/build/libs/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**ì´ë¯¸ì§€ ìµœì í™”**:
- Multi-stage Buildë¡œ ìµœì¢… ì´ë¯¸ì§€ í¬ê¸° ê°ì†Œ (ì•½ 300MB)
- JREë§Œ í¬í•¨ (JDK ë¶ˆí•„ìš”)
- Non-root user ì‚¬ìš© (ë³´ì•ˆ ê°•í™”)

#### Stage 4: Login to ECR
```groovy
stage('Login to ECR') {
    steps {
        withAWS(credentials: 'aws-cred', region: 'ap-northeast-2') {
            sh """
                aws ecr get-login-password --region ap-northeast-2 | \
                docker login --username AWS --password-stdin ${ECR_REGISTRY}
            """
        }
    }
}
```
- AWS CLIë¥¼ ì‚¬ìš©í•´ ECR ì¸ì¦ í† í° íšë“
- Docker CLIë¡œ ECR ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë¡œê·¸ì¸
- ì¸ì¦ í† í°ì€ 12ì‹œê°„ ìœ íš¨

#### Stage 5: Push to ECR (ë³‘ë ¬ ì²˜ë¦¬)
```groovy
stage('Push to ECR') {
    parallel {
        stage('Push Front') {
            steps {
                sh """
                    docker push ${ECR_REGISTRY}/front:${IMAGE_TAG}
                    docker push ${ECR_REGISTRY}/front:latest
                """
            }
        }
        stage('Push Back1') { /* ë™ì¼ */ }
        stage('Push Back2') { /* ë™ì¼ */ }
    }
}
```
- **ë³‘ë ¬ ì²˜ë¦¬**ë¡œ í‘¸ì‹œ ì‹œê°„ ë‹¨ì¶• (ì•½ 3ë°° ë¹ ë¦„)
- ê° ì´ë¯¸ì§€ëŠ” 2ê°œ íƒœê·¸ë¡œ í‘¸ì‹œ:
  - `latest`: í•­ìƒ ìµœì‹  ë²„ì „
  - `<BUILD_NUMBER>`: íŠ¹ì • ë²„ì „ (ë¡¤ë°±ìš©)

---

### 3ë‹¨ê³„: ECR ì´ë¯¸ì§€ í‘¸ì‹œ

#### ECR Repository êµ¬ì¡°
```
556152726180.dkr.ecr.ap-northeast-2.amazonaws.com/
â”œâ”€â”€ front/
â”‚   â”œâ”€â”€ latest (íƒœê·¸)
â”‚   â”œâ”€â”€ 1 (ë¹Œë“œ #1)
â”‚   â”œâ”€â”€ 2 (ë¹Œë“œ #2)
â”‚   â””â”€â”€ 3 (ë¹Œë“œ #3)
â”œâ”€â”€ back1/
â”‚   â”œâ”€â”€ latest
â”‚   â””â”€â”€ ...
â””â”€â”€ back2/
    â”œâ”€â”€ latest
    â””â”€â”€ ...
```

#### ì´ë¯¸ì§€ ë²„ì „ ê´€ë¦¬ ì „ëµ
- **latest íƒœê·¸**: ECS Task Definitionì—ì„œ í•­ìƒ ìµœì‹  ë²„ì „ ì°¸ì¡°
- **ë¹Œë“œ ë²ˆí˜¸ íƒœê·¸**: ë¡¤ë°± ë° ë²„ì „ ì¶”ì ìš©
- **ë¼ì´í”„ì‚¬ì´í´ ì •ì±…**: ìµœê·¼ 10ê°œ ì´ë¯¸ì§€ë§Œ ë³´ê´€ (ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ì ˆê°)

---

### 4ë‹¨ê³„: ECS ì„œë¹„ìŠ¤ ì¬ë°°í¬

#### Stage: Deploy to ECS (ë³‘ë ¬ ë°°í¬)
```groovy
stage('Deploy to ECS') {
    parallel {
        stage('Deploy Front') {
            steps {
                sh """
                    aws ecs update-service \
                        --cluster petclinic-cluster \
                        --service front-service \
                        --force-new-deployment \
                        --region ap-northeast-2
                """
            }
        }
        // back1, back2 ë™ì¼
    }
}
```

#### ECS ì¬ë°°í¬ í”„ë¡œì„¸ìŠ¤ (Rolling Update)
1. **ìƒˆ Task ì‹œì‘**
   - ECRì—ì„œ `latest` íƒœê·¸ ì´ë¯¸ì§€ Pull
   - Task Definitionì— ì •ì˜ëœ í™˜ê²½ë³€ìˆ˜ ì£¼ì…
   - ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)

2. **ALB Target Group ë“±ë¡**
   - ìƒˆ Taskì˜ IPì™€ í¬íŠ¸ë¥¼ Target Groupì— ë“±ë¡
   - ALB í—¬ìŠ¤ì²´í¬ ì‹œì‘ (`/actuator/health`)
   - Healthy ìƒíƒœê°€ ë˜ë©´ íŠ¸ë˜í”½ ìˆ˜ì‹  ì‹œì‘

3. **ê¸°ì¡´ Task ì¢…ë£Œ**
   - ìƒˆ Taskê°€ ì •ìƒ ë™ì‘ í™•ì¸ í›„
   - ê¸°ì¡´ Taskì— SIGTERM ì‹ í˜¸ ì „ì†¡
   - Graceful Shutdown (30ì´ˆ ëŒ€ê¸°)
   - ì™„ì „ ì¢…ë£Œ í›„ ë¦¬ì†ŒìŠ¤ íšŒìˆ˜

#### Task Definition ì£¼ìš” ì„¤ì •
```json
{
  "family": "petclinic-front-task",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "512",
  "memory": "1024",
  "containerDefinitions": [
    {
      "name": "petclinic-front",
      "image": "556152726180.dkr.ecr.ap-northeast-2.amazonaws.com/front:latest",
      "portMappings": [{ "containerPort": 8080 }],
      "environment": [
        { "name": "SPRING_PROFILES_ACTIVE", "value": "prod" }
      ],
      "secrets": [
        { "name": "DB_URL", "valueFrom": "arn:aws:secretsmanager:..." },
        { "name": "DB_USERNAME", "valueFrom": "..." },
        { "name": "DB_PASSWORD", "valueFrom": "..." }
      ],
      "healthCheck": {
        "command": ["CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1"],
        "interval": 30,
        "timeout": 5,
        "retries": 3,
        "startPeriod": 60
      }
    }
  ]
}
```

#### í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬
- **Secrets Manager**: ë¯¼ê° ì •ë³´ (DB ì ‘ì† ì •ë³´) ì•”í˜¸í™” ì €ì¥
- **í™˜ê²½ë³€ìˆ˜**: ë¹„ë¯¼ê° ì •ë³´ (í”„ë¡œíŒŒì¼ ì„¤ì •)
- Task ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ ì£¼ì…

---

### 5ë‹¨ê³„: ALBë¥¼ í†µí•œ ì„œë¹„ìŠ¤ ì‘ë‹µ

#### ALB êµ¬ì„±
```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Internet GW    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚       ALB        â”‚
                    â”‚  (Public Subnet) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
         â”‚  Front  â”‚   â”‚  Back1  â”‚   â”‚  Back2  â”‚
         â”‚ Target  â”‚   â”‚ Target  â”‚   â”‚ Target  â”‚
         â”‚  Group  â”‚   â”‚  Group  â”‚   â”‚  Group  â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚              â”‚              â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
         â”‚ ECS Taskâ”‚   â”‚ ECS Taskâ”‚   â”‚ ECS Taskâ”‚
         â”‚ (Privateâ”‚   â”‚ (Privateâ”‚   â”‚ (Privateâ”‚
         â”‚ Subnet) â”‚   â”‚ Subnet) â”‚   â”‚ Subnet) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Listener Rules (ê²½ë¡œ ê¸°ë°˜ ë¼ìš°íŒ…)
```
ALB Listener (Port 80)
â”œâ”€â”€ Rule 1: Path = /* â†’ Forward to front-target-group (ê°€ì¤‘ì¹˜ 100%)
â”œâ”€â”€ Rule 2: Path = /api/* â†’ Forward to back1-target-group (ê°€ì¤‘ì¹˜ 50%)
â”‚                          â””â”€> back2-target-group (ê°€ì¤‘ì¹˜ 50%)
â””â”€â”€ Default: 404 Not Found
```

#### Target Group Health Check
- **ì—”ë“œí¬ì¸íŠ¸**: `/actuator/health`
- **ê°„ê²©**: 30ì´ˆ
- **íƒ€ì„ì•„ì›ƒ**: 5ì´ˆ
- **ì •ìƒ ì„ê³„ê°’**: ì—°ì† 2íšŒ ì„±ê³µ
- **ë¹„ì •ìƒ ì„ê³„ê°’**: ì—°ì† 2íšŒ ì‹¤íŒ¨

**Health Check ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "status": "UP",
  "components": {
    "db": {
      "status": "UP",
      "details": {
        "database": "PostgreSQL",
        "validationQuery": "isValid()"
      }
    },
    "diskSpace": { "status": "UP" },
    "ping": { "status": "UP" }
  }
}
```

#### íŠ¸ë˜í”½ íë¦„
1. **ì‚¬ìš©ì ìš”ì²­**: `http://<alb-dns-name>/owners`
2. **ALB ìˆ˜ì‹ **: Listener Rule ë§¤ì¹­
3. **Target Group ì„ íƒ**: front-target-group
4. **Task ì„ íƒ**: Round-robin ë°©ì‹ìœ¼ë¡œ ë¶„ì‚°
5. **ì‘ë‹µ ë°˜í™˜**: Task â†’ ALB â†’ User

---

### 6ë‹¨ê³„: RDS PostgreSQL ì—°ë™

#### RDS êµ¬ì„±
- **ì—”ì§„**: PostgreSQL 14.x
- **ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…**: db.t3.micro (í”„ë¦¬í‹°ì–´)
- **Multi-AZ**: Master/Slave êµ¬ì„± (ê³ ê°€ìš©ì„±)
- **ìŠ¤í† ë¦¬ì§€**: 20GB SSD (ìë™ í™•ì¥ ê°€ëŠ¥)
- **ë°±ì—…**: ìë™ ë°±ì—… 7ì¼ ë³´ê´€

#### ì• í”Œë¦¬ì¼€ì´ì…˜ ì—°ë™
**application-prod.properties**:
```properties
spring.datasource.url=${DB_URL}
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
```

**ì—°ê²° í’€ ì„¤ì • (HikariCP)**:
```properties
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=20000
```

---

## ğŸ”’ ë„¤íŠ¸ì›Œí¬ ë° ë³´ì•ˆ êµ¬ì„±

### VPC êµ¬ì„±
```
VPC: 10.0.0.0/16
â”‚
â”œâ”€â”€ Public Subnet 1 (10.0.1.0/24) - AZ-A
â”‚   â”œâ”€â”€ ALB
â”‚   â””â”€â”€ NAT Gateway
â”‚
â”œâ”€â”€ Public Subnet 2 (10.0.2.0/24) - AZ-B
â”‚   â”œâ”€â”€ ALB (ë°±ì—…)
â”‚   â””â”€â”€ NAT Gateway (ë°±ì—…)
â”‚
â”œâ”€â”€ Private Subnet 1 (10.0.10.0/24) - AZ-A
â”‚   â””â”€â”€ ECS Tasks (front, back1, back2)
â”‚
â”œâ”€â”€ Private Subnet 2 (10.0.11.0/24) - AZ-B
â”‚   â””â”€â”€ ECS Tasks (ë°±ì—…)
â”‚
â”œâ”€â”€ Private Subnet 3 (10.0.20.0/24) - AZ-A
â”‚   â””â”€â”€ RDS Master
â”‚
â””â”€â”€ Private Subnet 4 (10.0.21.0/24) - AZ-B
    â””â”€â”€ RDS Slave
```

### ë³´ì•ˆ ê·¸ë£¹ ê·œì¹™

#### 1. ALB Security Group
| Type | Protocol | Port | Source | Description |
|------|----------|------|--------|-------------|
| Inbound | TCP | 80 | 0.0.0.0/0 | HTTP from Internet |
| Inbound | TCP | 443 | 0.0.0.0/0 | HTTPS from Internet |
| Outbound | TCP | 8080 | ECS-SG | To ECS Tasks |

#### 2. ECS Tasks Security Group
| Type | Protocol | Port | Source | Description |
|------|----------|------|--------|-------------|
| Inbound | TCP | 8080 | ALB-SG | From ALB |
| Outbound | TCP | 5432 | RDS-SG | To RDS |
| Outbound | TCP | 443 | 0.0.0.0/0 | AWS API Calls |

#### 3. RDS Security Group
| Type | Protocol | Port | Source | Description |
|------|----------|------|--------|-------------|
| Inbound | TCP | 5432 | ECS-SG | From ECS Tasks |

#### 4. Jenkins Security Group
| Type | Protocol | Port | Source | Description |
|------|----------|------|--------|-------------|
| Inbound | TCP | 8080 | MyIP | Jenkins UI |
| Inbound | TCP | 22 | MyIP | SSH Access |
| Outbound | TCP | All | 0.0.0.0/0 | Internet Access |

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### CloudWatch Logs
ê° ECS ì„œë¹„ìŠ¤ëŠ” ë³„ë„ ë¡œê·¸ ê·¸ë£¹ì— ì €ì¥:
- `/ecs/petclinic-front`
- `/ecs/petclinic-back1`
- `/ecs/petclinic-back2`

### ì£¼ìš” ë©”íŠ¸ë¦­
- **ECS**: CPU ì‚¬ìš©ë¥ , ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ , Task ê°œìˆ˜
- **ALB**: ìš”ì²­ ìˆ˜, ì‘ë‹µ ì‹œê°„, ì—ëŸ¬ ë¹„ìœ¨, Target Health
- **RDS**: ì—°ê²° ìˆ˜, CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬ I/O

### ì•ŒëŒ ì„¤ì • (ì˜ˆì‹œ)
```
Alarm: HighCPUUsage
Metric: ECS CPU > 80%
Period: 5ë¶„
Action: SNS ì•Œë¦¼ â†’ ë‹´ë‹¹ì ì´ë©”ì¼
```

---

## ğŸ”„ ë°°í¬ ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ

### ì •ìƒ ë°°í¬ ì‹œë‚˜ë¦¬ì˜¤
```
1. ê°œë°œìê°€ ì½”ë“œ í‘¸ì‹œ (14:00)
   â””â”€> Git Push ì™„ë£Œ

2. Jenkins ë¹Œë“œ ì‹œì‘ (14:00:10)
   â”œâ”€> Checkout: 10ì´ˆ
   â”œâ”€> Build: 2ë¶„ 30ì´ˆ
   â”œâ”€> Docker Build: 3ë¶„
   â”œâ”€> Push to ECR: 1ë¶„ 30ì´ˆ
   â””â”€> ì´ ì†Œìš” ì‹œê°„: 7ë¶„ 10ì´ˆ

3. ECS ì¬ë°°í¬ ì‹œì‘ (14:07:10)
   â”œâ”€> ìƒˆ Task ì‹œì‘: 1ë¶„
   â”œâ”€> Health Check: 30ì´ˆ
   â”œâ”€> ALB ë“±ë¡: 10ì´ˆ
   â””â”€> ê¸°ì¡´ Task ì¢…ë£Œ: 30ì´ˆ

4. ë°°í¬ ì™„ë£Œ (14:09:20)
   â””â”€> ì‚¬ìš©ìëŠ” ë¬´ì¤‘ë‹¨ìœ¼ë¡œ ìƒˆ ë²„ì „ ì‚¬ìš©
```

### ë¡¤ë°± ì‹œë‚˜ë¦¬ì˜¤
```
ë¬¸ì œ ë°œê²¬ ì‹œ:
1. Jenkinsì—ì„œ ì´ì „ ë²„ì „ ë¹Œë“œ ì¬ì‹¤í–‰
   ë˜ëŠ”
2. ECS Task Definitionì„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³€ê²½
   aws ecs update-service \
     --task-definition petclinic-front-task:5 \
     --service front-service

3. 5ë¶„ ì´ë‚´ ë¡¤ë°± ì™„ë£Œ
```

---

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™”

### 1. ë¹Œë“œ ìµœì í™”
- **Gradle ìºì‹±**: Jenkinsì—ì„œ `.gradle` ë””ë ‰í† ë¦¬ ìºì‹±
- **Docker Layer ìºì‹±**: ë³€ê²½ë˜ì§€ ì•Šì€ ë ˆì´ì–´ ì¬ì‚¬ìš©
- **ë³‘ë ¬ ë¹Œë“œ**: 3ê°œ ì´ë¯¸ì§€ ë™ì‹œ í‘¸ì‹œ

### 2. ëŸ°íƒ€ì„ ìµœì í™”
- **JVM íŠœë‹**:
  ```bash
  JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC"
  ```
- **Connection Pool**: HikariCP ìµœì í™” ì„¤ì •
- **ìºì‹±**: Spring Cache (Caffeine)ë¡œ DB ë¶€í•˜ ê°ì†Œ

### 3. ë„¤íŠ¸ì›Œí¬ ìµœì í™”
- **ALB Idle Timeout**: 60ì´ˆ
- **Keep-Alive**: HTTP 1.1 ì§€ì† ì—°ê²°
- **CDN**: ì •ì  ë¦¬ì†ŒìŠ¤ë¥¼ CloudFrontë¡œ ë°°í¬ (ì„ íƒì‚¬í•­)

---

## ğŸ› ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ

### ë¬¸ì œ 1: ë¹Œë“œ ì‹¤íŒ¨
**ì¦ìƒ**: Jenkins ë¹Œë“œê°€ ì‹¤íŒ¨í•¨
**ì›ì¸**:
- Gradle ë¹Œë“œ ì—ëŸ¬
- Docker ë¹Œë“œ ì‹¤íŒ¨
- ECR ê¶Œí•œ ë¶€ì¡±

**í•´ê²°**:
```bash
# Jenkins ë¡œê·¸ í™•ì¸
jenkins> Console Output í™•ì¸

# Gradle ë¹Œë“œ ë¡œì»¬ í…ŒìŠ¤íŠ¸
./gradlew clean build --stacktrace

# Docker ë¹Œë“œ ë¡œì»¬ í…ŒìŠ¤íŠ¸
docker build -t test .

# AWS ê¶Œí•œ í™•ì¸
aws ecr describe-repositories
```

### ë¬¸ì œ 2: ECS Taskê°€ ì‹œì‘ë˜ì§€ ì•ŠìŒ
**ì¦ìƒ**: Taskê°€ PENDING ìƒíƒœì—ì„œ ë©ˆì¶¤
**ì›ì¸**:
- ECR ì´ë¯¸ì§€ë¥¼ Pullí•  ìˆ˜ ì—†ìŒ
- IAM ê¶Œí•œ ë¶€ì¡±
- ì„œë¸Œë„·ì— NAT Gateway ì—†ìŒ

**í•´ê²°**:
```bash
# ECS ì´ë²¤íŠ¸ í™•ì¸
aws ecs describe-services --cluster petclinic-cluster --services front-service

# CloudWatch Logs í™•ì¸
aws logs tail /ecs/petclinic-front --follow

# Task Definition í™•ì¸
aws ecs describe-task-definition --task-definition petclinic-front-task
```

### ë¬¸ì œ 3: ALB Health Check ì‹¤íŒ¨
**ì¦ìƒ**: Targetì´ Unhealthy ìƒíƒœ
**ì›ì¸**:
- ì• í”Œë¦¬ì¼€ì´ì…˜ì´ 8080 í¬íŠ¸ì—ì„œ ë¦¬ìŠ¤ë‹í•˜ì§€ ì•ŠìŒ
- `/actuator/health` ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ ì—†ìŒ
- Security Group ê·œì¹™ ì˜¤ë¥˜

**í•´ê²°**:
```bash
# Taskì— ì ‘ì†í•´ì„œ í™•ì¸
aws ecs execute-command --cluster petclinic-cluster \
  --task <task-id> \
  --container petclinic-front \
  --interactive \
  --command "/bin/bash"

# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ
curl localhost:8080/actuator/health

# Target Group Health í™•ì¸
aws elbv2 describe-target-health --target-group-arn <arn>
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „ í™•ì¸ì‚¬í•­
- [ ] Jenkinsfileì´ GitHub ì €ì¥ì†Œì— í‘¸ì‹œë˜ì–´ ìˆìŒ
- [ ] ECR ë¦¬í¬ì§€í† ë¦¬ 3ê°œê°€ ìƒì„±ë˜ì–´ ìˆìŒ (front, back1, back2)
- [ ] ECS í´ëŸ¬ìŠ¤í„°ì™€ ì„œë¹„ìŠ¤ê°€ ìƒì„±ë˜ì–´ ìˆìŒ
- [ ] RDS PostgreSQLì´ ìƒì„±ë˜ê³  ì ‘ê·¼ ê°€ëŠ¥í•¨
- [ ] ALBì™€ Target Groupì´ êµ¬ì„±ë˜ì–´ ìˆìŒ
- [ ] Security Group ê·œì¹™ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë¨
- [ ] IAM Roleê³¼ ê¶Œí•œì´ ì„¤ì •ë˜ì–´ ìˆìŒ

### ë°°í¬ í›„ í™•ì¸ì‚¬í•­
- [ ] Jenkins ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë¨
- [ ] ECRì— ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì–´ ìˆìŒ
- [ ] ECS Taskê°€ RUNNING ìƒíƒœì„
- [ ] ALB Targetì´ Healthy ìƒíƒœì„
- [ ] ë¸Œë¼ìš°ì €ì—ì„œ ALB DNSë¡œ ì ‘ì† ê°€ëŠ¥í•¨
- [ ] CloudWatch Logsì— ë¡œê·¸ê°€ ê¸°ë¡ë˜ê³  ìˆìŒ

---

## ğŸ¯ ê²°ë¡ 

ë³¸ í”„ë¡œì íŠ¸ëŠ” **Git Push â†’ Jenkins â†’ ECR â†’ ECS â†’ ALB â†’ RDS**ë¡œ ì´ì–´ì§€ëŠ” ì™„ì „ ìë™í™”ëœ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

### í•µì‹¬ ì„±ê³¼
1. **ìë™í™”**: ì½”ë“œ í‘¸ì‹œ í›„ ì•½ 10ë¶„ ì´ë‚´ ìë™ ë°°í¬ ì™„ë£Œ
2. **ë¬´ì¤‘ë‹¨ ë°°í¬**: Rolling Updateë¡œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ìŒ
3. **ê³ ê°€ìš©ì„±**: 2AZ ë¶„ì‚°, ALB ë¡œë“œë°¸ëŸ°ì‹±, RDS Multi-AZ
4. **ë³´ì•ˆ**: Private Subnet, Security Group, Secrets Manager í™œìš©
5. **ëª¨ë‹ˆí„°ë§**: CloudWatch Logs ë° Metricsë¡œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

### í•™ìŠµ ë‚´ìš©
- Docker ì»¨í…Œì´ë„ˆí™” ë° Multi-stage Build
- Jenkins Pipelineì„ í†µí•œ CI/CD êµ¬ì¶•
- AWS ECS Fargate ì„œë²„ë¦¬ìŠ¤ ì»¨í…Œì´ë„ˆ ìš´ì˜
- ALBë¥¼ í†µí•œ L7 ë¡œë“œë°¸ëŸ°ì‹±
- RDS PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™
- VPC ë„¤íŠ¸ì›Œí¬ ë° ë³´ì•ˆ êµ¬ì„±

---

**ì‘ì„±ì¼**: 2025ë…„
**ì‘ì„±ì**: [ì´ë¦„]
**í”„ë¡œì íŠ¸**: Spring PetClinic DevOps CI/CD êµ¬ì¶•
